<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jamie's Nail å ±åƒ¹ç³»çµ± V4.1</title>
    <style>
        :root {
            --primary-color: #d4a5a5; /* è—•ç²‰è‰²ä¸»èª¿ */
            --primary-dark: #b58585;
            --bg-color: #fdfbfb;
            --text-color: #4a4a4a;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --accent-foot: #e8c495; /* è¶³éƒ¨æ¨¡å¼æš–è‰² */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); padding-bottom: 240px; /* ç•™çµ¦åº•éƒ¨çµå¸³å€æ›´å¤šç©ºé–“ */ }

        /* --- Header & Control --- */
        header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #eee;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .mode-switch {
            display: flex; background: #eee; border-radius: 20px; padding: 4px; margin-bottom: 10px;
        }
        .mode-btn {
            flex: 1; border: none; background: transparent; padding: 10px; border-radius: 16px;
            font-weight: bold; color: #888; transition: all 0.2s; cursor: pointer;
        }
        .mode-btn.active { background: white; color: var(--text-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .mode-btn.foot-active { color: #8a6d3b; }

        /* è¶³éƒ¨æ¨¡å¼æ™‚çš„è¦–è¦ºè®ŠåŒ– */
        body.foot-mode .mode-btn.active { background: var(--accent-foot); color: white; }
        body.foot-mode { --primary-color: #e8c495; }

        /* --- Category Tabs --- */
        .category-scroll {
            display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; scrollbar-width: none;
        }
        .cat-btn {
            white-space: nowrap; padding: 6px 16px; border-radius: 20px; border: 1px solid #ddd;
            background: white; color: #666; font-size: 14px; cursor: pointer;
        }
        .cat-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* --- Item Grid --- */
        .item-container { padding: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .item-card {
            background: white; padding: 15px; border-radius: var(--border-radius);
            box-shadow: var(--shadow); border: 1px solid #f0f0f0; text-align: center; cursor: pointer;
            transition: transform 0.1s; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .item-card:active { transform: scale(0.96); }
        .item-name { font-size: 15px; font-weight: 500; margin-bottom: 5px; }
        .item-price { font-size: 13px; color: #888; }
        
        /* è‡ªè¨‚è¼¸å…¥å€ */
        .custom-input-group {
            grid-column: span 2; display: flex; gap: 8px; background: white; padding: 10px;
            border-radius: var(--border-radius); box-shadow: var(--shadow);
        }
        .custom-input-group input {
            flex: 1; border: 1px solid #ddd; padding: 8px; border-radius: 8px; outline: none;
        }
        .custom-btn {
            background: var(--text-color); color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold;
        }

        /* --- Cart List --- */
        .cart-section { padding: 0 15px 20px 15px; }
        .cart-title { font-size: 14px; color: #999; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        .cart-item {
            display: flex; align-items: center; background: white; margin-bottom: 8px;
            padding: 10px; border-radius: 10px; border-left: 4px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03); transition: all 0.3s;
        }
        .cart-item.discount-active { border-left-color: #ff6b6b; background: #fff5f5; }
        
        .check-col { padding-right: 10px; display: flex; flex-direction: column; align-items: center; }
        .discount-checkbox { transform: scale(1.3); accent-color: #ff6b6b; }
        .discount-label { font-size: 10px; color: #aaa; margin-top: 2px; }

        .info-col { flex: 1; }
        .edit-input {
            width: 100%; border: none; background: transparent; outline: none;
            font-size: 15px; color: #333; margin-bottom: 2px;
        }
        .edit-price {
            width: 100%; border: none; background: transparent; outline: none;
            font-size: 14px; color: #666; font-weight: bold;
        }
        .cart-item.adjustment .edit-price { color: #d63031; }

        .action-col { padding-left: 10px; }
        .del-btn {
            background: #f1f1f1; color: #999; border: none; width: 30px; height: 30px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }

        /* --- Checkout Footer --- */
        .checkout-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 1px solid #eee;
            padding: 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 200;
        }
        
        .discount-options { display: flex; gap: 5px; margin-bottom: 15px; align-items: center; }
        .disc-btn {
            flex: 1; padding: 10px 5px; border: 1px solid #ddd; background: white; border-radius: 8px;
            font-size: 13px; color: #666; white-space: nowrap; text-align: center; cursor: pointer;
        }
        .disc-btn.selected { background: #4a4a4a; color: white; border-color: #4a4a4a; }
        
        /* è‡ªè¨‚æŠ˜æ‰£è¼¸å…¥æ¡†æ¨£å¼ */
        .disc-input-wrapper {
            flex: 1.5; /* æ¯”æŒ‰éˆ•ç¨å¾®å¯¬ä¸€é» */
            position: relative; display: flex; align-items: center;
        }
        .disc-input-wrapper input {
            width: 100%; padding: 8px 30px 8px 8px; /* å³é‚Šç•™ç©ºçµ¦å–®ä½ */
            border: 1px solid #ddd; border-radius: 8px;
            font-size: 14px; text-align: center; outline: none;
            background: #fff; color: #333; font-weight: bold;
            transition: border 0.2s; height: 38px; /* èˆ‡æŒ‰éˆ•ç­‰é«˜ */
        }
        .disc-input-wrapper input:focus { border-color: var(--primary-color); background: #fffbfb; }
        .disc-unit { 
            position: absolute; right: 10px; color: #999; 
            font-size: 12px; pointer-events: none; font-weight: normal; 
        }

        .total-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .total-label { font-size: 14px; color: #888; }
        .total-amount { font-size: 28px; font-weight: 800; color: #333; line-height: 1; }
        
        /* åº•éƒ¨æŒ‰éˆ•ä¸‰æ¬„æ’åˆ— */
        .action-row { display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 8px; }
        .btn-reset { background: #f1f1f1; color: #666; border: none; padding: 12px; border-radius: 10px; font-weight: bold; }
        .btn-view { background: #e3e3e3; color: #333; border: none; padding: 12px; border-radius: 10px; font-weight: bold; }
        .btn-copy { background: #4a4a4a; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-copy:active { background: #222; }

        /* --- æ˜ç´°å½ˆçª—æ¨£å¼ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 999;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.3s;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        
        .modal-card {
            background: white; width: 90%; max-width: 350px;
            border-radius: 15px; padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: translateY(20px); transition: all 0.3s;
            display: flex; flex-direction: column; max-height: 80vh;
        }
        .modal-overlay.show .modal-card { transform: translateY(0); }

        .receipt-header { text-align: center; border-bottom: 2px dashed #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .receipt-header h3 { margin: 0; color: #333; font-size: 18px; }
        .receipt-header p { margin: 5px 0 0; color: #999; font-size: 12px; }

        .receipt-body { flex: 1; overflow-y: auto; font-family: monospace; font-size: 14px; margin-bottom: 15px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .receipt-row.sub { color: #888; font-size: 12px; margin-top: -6px; margin-bottom: 8px; justify-content: flex-end; }
        
        .receipt-footer { border-top: 2px dashed #eee; padding-top: 15px; }
        .receipt-total { display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; color: #333; }
        
        .btn-close { 
            width: 100%; background: #f1f1f1; border: none; padding: 12px; 
            border-radius: 10px; font-weight: bold; margin-top: 15px; color: #666; 
        }

        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 200px; background-color: rgba(0,0,0,0.8); color: #fff;
            text-align: center; border-radius: 25px; padding: 12px; position: fixed; z-index: 300;
            left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        @keyframes fadein { from {bottom: 60px; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 60px; opacity: 0;} }
    </style>
</head>
<body>

<header>
    <div class="mode-switch">
        <button class="mode-btn active" onclick="setMode('hand')">ğŸ–ï¸ æ‰‹éƒ¨</button>
        <button class="mode-btn" onclick="setMode('foot')">ğŸ¦¶ è¶³éƒ¨ (+$100)</button>
    </div>
    <div class="category-scroll" id="categoryList">
        </div>
</header>

<main>
    <div class="item-container" id="itemList">
        </div>

    <div class="cart-section">
        <div class="cart-title">
            <span>å·²é¸é …ç›® (é»æ“Šå¯ç·¨è¼¯)</span>
            <span style="font-size:12px">æ‰“æŠ˜?</span>
        </div>
        <div id="cartList">
            </div>
    </div>
</main>

<div class="checkout-bar">
    <div class="discount-options">
        <div class="disc-btn selected" onclick="setDiscount(1, this)">åŸåƒ¹</div>
        <div class="disc-btn" onclick="setDiscount(0.9, this)">9æŠ˜</div>
        <div class="disc-btn" onclick="setDiscount(0.7, this)">7æŠ˜</div>
        
        <div class="disc-input-wrapper">
            <input type="number" id="customRateInput" placeholder="è‡ªè¨‚" oninput="applyCustomDiscount(this.value)">
            <span class="disc-unit">æŠ˜/%</span>
        </div>
    </div>

    <div class="total-row">
        <div class="total-label">ç¸½é‡‘é¡ Total</div>
        <div class="total-amount" id="finalTotal">$0</div>
    </div>

    <div class="action-row">
        <button class="btn-reset" onclick="resetCart()">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button class="btn-view" onclick="showDetailModal()">ğŸ“„ æŸ¥çœ‹</button>
        <button class="btn-copy" onclick="copyReceipt()">ğŸ“‹ è¤‡è£½æ˜ç´°</button>
    </div>
</div>

<div id="toast">å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>

<div id="detailModal" class="modal-overlay" onclick="if(event.target === this) closeDetailModal()">
    <div class="modal-card">
        <div class="receipt-header">
            <h3>Jamie's Nail</h3>
            <p id="receiptDate">2026/01/17</p>
        </div>
        <div class="receipt-body" id="receiptContent">
            </div>
        <div class="receipt-footer">
            <div class="receipt-total">
                <span>ç¸½é‡‘é¡</span>
                <span id="receiptTotal">$0</span>
            </div>
            <button class="btn-close" onclick="closeDetailModal()">é—œé–‰ Close</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. è¨­å®šæª” (Configuration)
    // ==========================================
    const CONFIG = {
        footSurcharge: 100, // è¶³éƒ¨åŠ åƒ¹é‡‘é¡
        categories: [
            { id: 'care', name: 'åŸºç¤ä¿é¤Š' },
            { id: 'gel', name: 'å‡è† é …ç›®' },
            { id: 'art', name: 'é€ å‹è¨­è¨ˆ' },
            { id: 'remove', name: 'å¸ç”²/ç¶­è­·' },
            { id: 'adjust', name: 'èª¿æ•´/æŠ˜æ‰£' }
        ],
        // æœå‹™èœå–®
        menu: {
            care: [
                { name: 'åŸºç¤ä¿é¤Š', price: 500 },
                { name: 'å«©è†šä¿é¤Š', price: 700 },
                { name: 'æ·±å±¤ä¿é¤Š', price: 1000 }
            ],
            gel: [
                { name: 'é€æ˜å‡è† ', price: 780 },
                { name: 'å–®è‰²å‡è† ', price: 1000 },
                { name: 'é¡é¢ç²‰', price: 1200 },
                { name: 'è²“çœ¼', price: 1100 },
                { name: 'æ³•å¼', price: 1300 },
                { name: 'æ¼¸å±¤', price: 1200 },
                { name: 'å„ªæƒ æ¬¾', price: 1399, isFlat: true }, // ç‰¹åƒ¹æ¬¾é€šå¸¸ä¸åŠ åƒ¹ï¼Œè¨­ç‚º isFlat
                { name: 'åº•è‰²', price: 300 }
            ],
            art: [
                { name: 'é€ å‹(A)', price: 100 },
                { name: 'é€ å‹(B)', price: 150 },
                { name: 'é€ å‹(C)', price: 200 },
                { name: 'è²¼ç´™/é£¾å“', price: 50 },
                { name: 'è£œæ–·ç”²(å–®æŒ‡)', price: 100 }
            ],
            remove: [
                { name: 'æœ¬åº—å¸ç”²çºŒä½œ', price: 200 },
                { name: 'ä»–åº—å¸ç”²çºŒä½œ', price: 300 },
                { name: 'å¸å‡è† ï¼ˆå››æŒ‡ä»¥ä¸‹ï¼‰', price: 50 },
                { name: 'æœ¬åº—ç´”å¸ç”²ï¼ˆå«ä¿®å‰ªï¼‰', price: 400 },
                { name: 'ä»–åº—ç´”å¸ç”²ï¼ˆå«ä¿®å‰ªï¼‰', price: 500 }
            ],
            adjust: [
                { name: 'é¦–å®¢æŠ˜æŠµ', price: -100, isFlat: true },
                { name: 'è¨‚é‡‘æ‰£é™¤', price: -1000, isFlat: true }
            ]
        }
    };

    // ==========================================
    // 2. ç‹€æ…‹ç®¡ç† (State)
    // ==========================================
    let state = {
        mode: 'hand', // 'hand' or 'foot'
        currentCat: 'gel',
        cart: [], // { id, name, price, discountActive }
        globalDiscount: 1 // 1 = åŸåƒ¹, 0.9 = 9æŠ˜
    };

    // å˜—è©¦è®€å– LocalStorage
    const savedState = localStorage.getItem('jamieNailStateV4');
    if (savedState) {
        const parsed = JSON.parse(savedState);
        state.cart = parsed.cart || [];
        // ä¸é‚„åŸæŠ˜æ‰£ç‹€æ…‹ï¼Œé¿å…ä¸Šæ¬¡çš„è¨­å®šå¹²æ“¾é€™æ¬¡
    }

    // ==========================================
    // 3. æ ¸å¿ƒåŠŸèƒ½ (Functions)
    // ==========================================

    // åˆå§‹åŒ–
    function init() {
        renderCategories();
        renderItems();
        renderCart();
        updateTotal();
    }

    // åˆ‡æ› æ‰‹éƒ¨/è¶³éƒ¨
    function setMode(mode) {
        state.mode = mode;
        
        // UI æ›´æ–°
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        if (mode === 'foot') {
            document.querySelector('button[onclick="setMode(\'foot\')"]').classList.add('active');
            document.body.classList.add('foot-mode');
        } else {
            document.querySelector('button[onclick="setMode(\'hand\')"]').classList.add('active');
            document.body.classList.remove('foot-mode');
        }

        // é‡æ–°æ¸²æŸ“é …ç›®åƒ¹æ ¼ (é è¦½ç”¨)
        renderItems();
    }

    // åˆ‡æ›åˆ†é¡
    function setCategory(catId) {
        state.currentCat = catId;
        renderCategories();
        renderItems();
    }

    // æ¸²æŸ“åˆ†é¡æŒ‰éˆ•
    function renderCategories() {
        const container = document.getElementById('categoryList');
        if(!container) return; // å®‰å…¨æª¢æŸ¥
        container.innerHTML = CONFIG.categories.map(cat => `
            <button class="cat-btn ${state.currentCat === cat.id ? 'active' : ''}" 
                    onclick="setCategory('${cat.id}')">
                ${cat.name}
            </button>
        `).join('');
    }

    // æ¸²æŸ“æœå‹™é …ç›®
    function renderItems() {
        const container = document.getElementById('itemList');
        if(!container) return; // å®‰å…¨æª¢æŸ¥
        const items = CONFIG.menu[state.currentCat];
        let html = '';

        // å¦‚æœæ˜¯é€ å‹æˆ–èª¿æ•´ï¼Œé¡¯ç¤ºè‡ªè¨‚è¼¸å…¥æ¡†
        if (state.currentCat === 'art' || state.currentCat === 'adjust') {
            html += `
                <div class="custom-input-group">
                    <input type="text" id="customName" placeholder="é …ç›®åç¨±">
                    <input type="number" id="customPrice" placeholder="é‡‘é¡">
                    <button class="custom-btn" onclick="addCustomItem()">åŠ å…¥</button>
                </div>
            `;
        }

        // ç”¢ç”ŸæŒ‰éˆ•åˆ—è¡¨
        html += items.map(item => {
            // è¨ˆç®—é¡¯ç¤ºåƒ¹æ ¼
            let displayPrice = item.price;
            let displayName = item.name;
            let isPlus = false;

            // åªæœ‰éå›ºå®šåƒ¹æ ¼é …ç›® (isFlat != true) ä¸”åœ¨è¶³éƒ¨æ¨¡å¼ä¸‹æ‰åŠ åƒ¹
            // ä¸”èª¿æ•´é¡é€šå¸¸ä¸åŠ åƒ¹
            if (state.mode === 'foot' && !item.isFlat && state.currentCat !== 'adjust') {
                displayPrice += CONFIG.footSurcharge;
                displayName = `è¶³éƒ¨${item.name}`;
                isPlus = true;
            } else if (state.mode === 'hand' && !item.isFlat && state.currentCat !== 'adjust') {
                displayName = `æ‰‹éƒ¨${item.name}`;
            }

            return `
                <div class="item-card" onclick="addToCart('${displayName}', ${displayPrice})">
                    <div class="item-name">${item.name}</div>
                    <div class="item-price" style="${isPlus ? 'color:#d63031;font-weight:bold' : ''}">
                        $${displayPrice}
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = html;
    }

    // åŠ å…¥è³¼ç‰©è»Š
    function addToCart(name, price) {
        const newItem = {
            id: Date.now(),
            name: name,
            price: parseInt(price),
            discountActive: false // é è¨­ä¸æ‰“æŠ˜
        };
        state.cart.push(newItem);
        saveState();
        renderCart();
        updateTotal();
    }

    // åŠ å…¥è‡ªè¨‚é …ç›®
    function addCustomItem() {
        const nameInput = document.getElementById('customName');
        const priceInput = document.getElementById('customPrice');
        const name = nameInput.value.trim();
        const price = parseInt(priceInput.value);

        if (name && !isNaN(price)) {
            let finalName = name;
            // å¦‚æœæ˜¯åœ¨è¶³éƒ¨æ¨¡å¼ä¸”ä¸æ˜¯è² æ•¸èª¿æ•´ï¼Œè‡ªå‹•åŠ ä¸Šå‰ç¶´æ–¹ä¾¿è¾¨è­˜ (å¯é¸)
            if (state.mode === 'foot' && price > 0) finalName = `(è¶³) ${name}`;
            
            addToCart(finalName, price);
            nameInput.value = '';
            priceInput.value = '';
        }
    }

    // æ¸²æŸ“è³¼ç‰©è»Š (æ ¸å¿ƒ)
    function renderCart() {
        const container = document.getElementById('cartList');
        if (state.cart.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#ccc;padding:20px;">å°šç„¡é …ç›®</div>';
            return;
        }

        container.innerHTML = state.cart.map((item, index) => {
            const isNegative = item.price < 0;
            const itemClass = isNegative ? 'cart-item adjustment' : 
                              (item.discountActive ? 'cart-item discount-active' : 'cart-item');
            
            return `
                <div class="${itemClass}">
                    <div class="check-col">
                        <input type="checkbox" class="discount-checkbox" 
                               onchange="toggleDiscount(${index})" 
                               ${item.discountActive ? 'checked' : ''}
                               ${isNegative ? 'disabled' : ''}> ${!isNegative ? '<span class="discount-label">æŠ˜æ‰£</span>' : ''}
                    </div>
                    <div class="info-col">
                        <input type="text" class="edit-input" value="${item.name}" 
                               onchange="updateItemName(${index}, this.value)">
                        <input type="number" class="edit-price" value="${item.price}" 
                               onchange="updateItemPrice(${index}, this.value)">
                    </div>
                    <div class="action-col">
                        <button class="del-btn" onclick="removeItem(${index})">âœ•</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // è³¼ç‰©è»Šæ“ä½œå‡½å¼
    function removeItem(index) {
        state.cart.splice(index, 1);
        saveState();
        renderCart();
        updateTotal();
    }

    function updateItemName(index, val) {
        state.cart[index].name = val;
        saveState();
    }

    function updateItemPrice(index, val) {
        state.cart[index].price = parseInt(val);
        saveState();
        updateTotal();
    }

    function toggleDiscount(index) {
        state.cart[index].discountActive = !state.cart[index].discountActive;
        saveState();
        renderCart(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°èƒŒæ™¯è‰²
        updateTotal();
    }

    // è¨­å®šå›ºå®šæŠ˜æ‰£ (é»æ“ŠæŒ‰éˆ•æ™‚è§¸ç™¼)
    function setDiscount(rate, btnElement) {
        state.globalDiscount = rate;
        
        // UI æ›´æ–°ï¼šäº®èµ·æŒ‰éˆ•ï¼Œä¸¦æ¸…ç©ºè‡ªè¨‚è¼¸å…¥æ¡†
        document.querySelectorAll('.disc-btn').forEach(btn => btn.classList.remove('selected'));
        if(btnElement) btnElement.classList.add('selected');
        
        const input = document.getElementById('customRateInput');
        if(input) input.value = ''; // æ¸…ç©ºè¼¸å…¥
        updateTotal();
    }

    // æ‡‰ç”¨è‡ªè¨‚æŠ˜æ‰£ (è¼¸å…¥æ–‡å­—æ™‚è§¸ç™¼)
    function applyCustomDiscount(val) {
        // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„é¸å–ç‹€æ…‹
        document.querySelectorAll('.disc-btn').forEach(btn => btn.classList.remove('selected'));

        if (!val) {
            state.globalDiscount = 1; // ç©ºç™½å‰‡å›æ­¸åŸåƒ¹
        } else {
            let num = parseFloat(val);
            // æ™ºæ…§è½‰æ›é‚è¼¯
            if (num > 10) { 
                // è¼¸å…¥ 85 ä»£è¡¨ 0.85 (85æŠ˜/85%)
                state.globalDiscount = num / 100; 
            } else if (num >= 1 && num <= 10) {
                // è¼¸å…¥ 8 ä»£è¡¨ 0.8 (8æŠ˜)
                // è¼¸å…¥ 7.5 ä»£è¡¨ 0.75 (75æŠ˜)
                state.globalDiscount = num / 10;
            } else if (num < 1 && num > 0) {
                // è¼¸å…¥ 0.88 ä»£è¡¨ 0.88
                state.globalDiscount = num;
            }
        }
        updateTotal();
    }

    // è¨ˆç®—ç¸½é‡‘é¡ (Logic V4.1)
    function updateTotal() {
        let total = 0;
        
        state.cart.forEach(item => {
            if (item.discountActive) {
                // æœ‰å‹¾é¸æŠ˜æ‰£çš„é …ç›®ï¼šæ‰“æŠ˜å¾Œå››æ¨äº”å…¥
                total += Math.round(item.price * state.globalDiscount);
            } else {
                // æ²’å‹¾é¸çš„é …ç›®ï¼šåŸåƒ¹ (åŒ…å«è² æ•¸èª¿æ•´)
                total += item.price;
            }
        });

        document.getElementById('finalTotal').innerText = '$' + total;
    }

    function resetCart() {
        if(confirm('ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ')) {
            state.cart = [];
            saveState();
            renderCart();
            updateTotal();
        }
    }

    function saveState() {
        localStorage.setItem('jamieNailStateV4', JSON.stringify({ cart: state.cart }));
    }

    // ==========================================
    // 4. è¼¸å‡ºåŠŸèƒ½ (Generate Receipt)
    // ==========================================
    
    // è¼”åŠ©å‡½å¼ï¼šå–å¾—é¡¯ç¤ºç”¨çš„æŠ˜æ‰£æ–‡å­—
    function getDiscountText(rate) {
        if (rate === 1) return 'åŸåƒ¹';
        
        // å¦‚æœæ˜¯ 0.9, 0.8, 0.7 -> é¡¯ç¤º "9æŠ˜", "8æŠ˜"
        if (Math.abs(rate % 0.1) < 0.0001) { 
            return (rate * 10).toFixed(0) + 'æŠ˜';
        }
        // å¦‚æœæ˜¯ 0.85, 0.77 -> é¡¯ç¤º "85æŠ˜", "77æŠ˜"
        return (rate * 100).toFixed(0) + 'æŠ˜';
    }

    function copyReceipt() {
        if (state.cart.length === 0) return;

        const now = new Date();
        const dateStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

        let text = `ã€Jamie's Nail æœå‹™æ˜ç´°ã€‘\n`;
        text += `ğŸ“… ${dateStr}\n\n`;

        state.cart.forEach(item => {
            let line = `â–ªï¸ ${item.name} $${item.price}`;
            
            // åªæœ‰ç•¶è©²é …ç›®çœŸçš„è¢«æ‰“æŠ˜äº†
            if (item.discountActive && state.globalDiscount < 1) {
                const discountedPrice = Math.round(item.price * state.globalDiscount);
                const discountText = getDiscountText(state.globalDiscount);
                line += ` (${discountText}å¾Œ $${discountedPrice})`;
            }
            
            text += `${line}\n`;
        });

        text += `\n-------------------\n`;
        text += `ç¸½é‡‘é¡ï¼š${document.getElementById('finalTotal').innerText}`;

        // è¤‡è£½åˆ°å‰ªè²¼ç°¿
        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById("toast");
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }).catch(err => {
            alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•æˆªåœ–');
        });
    }

    // ==========================================
    // 5. æ˜ç´°å½ˆçª—åŠŸèƒ½ (Receipt Modal)
    // ==========================================
    function showDetailModal() {
        if (state.cart.length === 0) {
            alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼");
            return;
        }

        // 1. è¨­å®šæ—¥æœŸ
        const now = new Date();
        const dateStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        document.getElementById('receiptDate').innerText = dateStr;

        // 2. ç”Ÿæˆå…§å®¹
        const container = document.getElementById('receiptContent');
        let html = '';

        state.cart.forEach(item => {
            // åˆ¤æ–·æ˜¯å¦æ‰“æŠ˜
            const isDiscounted = item.discountActive && state.globalDiscount < 1;
            const finalPrice = isDiscounted ? Math.round(item.price * state.globalDiscount) : item.price;
            
            // ä¸»æ¨™é¡Œè¡Œ (åç¨± + æœ€çµ‚é‡‘é¡)
            html += `
                <div class="receipt-row">
                    <span>${item.name}</span>
                    <span>$${finalPrice}</span>
                </div>
            `;

            // å¦‚æœæœ‰æ‰“æŠ˜ï¼Œé¡¯ç¤ºåŸåƒ¹èˆ‡æŠ˜æ•¸èªªæ˜ (ç°è‰²å°å­—)
            if (isDiscounted) {
                const discountText = getDiscountText(state.globalDiscount);
                html += `
                    <div class="receipt-row sub">
                        (åŸåƒ¹$${item.price} â†˜ ${discountText})
                    </div>
                `;
            }
        });
        container.innerHTML = html;

        // 3. è¨­å®šç¸½é‡‘é¡
        document.getElementById('receiptTotal').innerText = document.getElementById('finalTotal').innerText;

        // 4. é¡¯ç¤ºè¦–çª—
        document.getElementById('detailModal').classList.add('show');
    }

    function closeDetailModal() {
        document.getElementById('detailModal').classList.remove('show');
    }

    // å•Ÿå‹•
    init();

</script>
</body>
</html>

