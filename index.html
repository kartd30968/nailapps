<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Jamie's Nail">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jamie's Nail å ±åƒ¹ç³»çµ±</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* åŸå§‹é…è‰² */
            --primary-color: #d4a5a5; /* è—•ç²‰è‰²ä¸»èª¿ */
            --primary-dark: #b58585;
            --bg-color: #fdfbfb;
            --text-color: #4a4a4a;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --accent-foot: #e8c495; /* è¶³éƒ¨æ¨¡å¼æš–è‰² */
            
            /* æ–°å¢ï¼šè¼¸å‡ºåœ–ç‰‡å°ˆç”¨è‰²ç¥¨ (å¥¶èŒ¶è‰²ç³») */
            --milk-tea-bg: #E6D0B3;
            --milk-tea-text: #5D4037;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); padding-bottom: 240px; }

        /* --- Header & Control --- */
        header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #eee;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .mode-switch { display: flex; background: #eee; border-radius: 20px; padding: 4px; margin-bottom: 10px; }
        .mode-btn { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 16px; font-weight: bold; color: #888; transition: all 0.2s; cursor: pointer; }
        .mode-btn.active { background: white; color: var(--text-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        body.foot-mode .mode-btn.active { background: var(--accent-foot); color: white; }
        body.foot-mode { --primary-color: #e8c495; }

        /* --- Category Tabs --- */
        .category-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; scrollbar-width: none; }
        .cat-btn { white-space: nowrap; padding: 6px 16px; border-radius: 20px; border: 1px solid #ddd; background: white; color: #666; font-size: 14px; cursor: pointer; }
        .cat-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* --- Item Grid --- */
        .item-container { padding: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .item-card {
            background: white; padding: 15px; border-radius: var(--border-radius);
            box-shadow: var(--shadow); border: 1px solid #f0f0f0; text-align: center; cursor: pointer;
            transition: transform 0.1s; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .item-card:active { transform: scale(0.96); }
        .item-name { font-size: 15px; font-weight: 500; margin-bottom: 5px; }
        .item-price { font-size: 13px; color: #888; }
        
        /* è‡ªè¨‚è¼¸å…¥å€ */
        .custom-input-group { grid-column: span 2; display: flex; gap: 8px; background: white; padding: 10px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .custom-input-group input { flex: 1; border: 1px solid #ddd; padding: 8px; border-radius: 8px; outline: none; }
        .custom-btn { background: var(--text-color); color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; }

        /* --- Cart List --- */
        .cart-section { padding: 0 15px 20px 15px; }
        .cart-title { font-size: 14px; color: #999; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        .cart-item {
            display: flex; align-items: center; background: white; margin-bottom: 8px;
            padding: 10px; border-radius: 10px; border-left: 4px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03); transition: all 0.3s;
        }
        .cart-item.discount-active { border-left-color: #ff6b6b; background: #fff5f5; }
        .check-col { padding-right: 10px; display: flex; flex-direction: column; align-items: center; }
        .discount-checkbox { transform: scale(1.3); accent-color: #ff6b6b; }
        .discount-label { font-size: 10px; color: #aaa; margin-top: 2px; }

        .info-col { flex: 1; }
        .edit-input { width: 100%; border: none; background: transparent; outline: none; font-size: 15px; color: #333; margin-bottom: 2px; }
        .edit-price { width: 100%; border: none; background: transparent; outline: none; font-size: 14px; color: #666; font-weight: bold; }
        .cart-item.adjustment .edit-price { color: #d63031; }

        .action-col { padding-left: 10px; }
        .del-btn { background: #f1f1f1; color: #999; border: none; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* --- Checkout Footer --- */
        .checkout-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 1px solid #eee;
            padding: 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 200;
        }
        
        .discount-options { display: flex; gap: 5px; margin-bottom: 15px; align-items: center; }
        .disc-btn {
            flex: 1; padding: 10px 5px; border: 1px solid #ddd; background: white; border-radius: 8px;
            font-size: 13px; color: #666; white-space: nowrap; text-align: center; cursor: pointer;
        }
        .disc-btn.selected { background: #4a4a4a; color: white; border-color: #4a4a4a; }
        
        .disc-input-wrapper {
            flex: 1.5; position: relative; display: flex; align-items: center;
        }
        .disc-input-wrapper input {
            width: 100%; padding: 8px 30px 8px 8px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 14px; text-align: center; outline: none; background: #fff; color: #333; font-weight: bold;
            transition: border 0.2s; height: 38px;
        }
        .disc-input-wrapper input:focus { border-color: var(--primary-color); background: #fffbfb; }
        .disc-unit { position: absolute; right: 10px; color: #999; font-size: 12px; pointer-events: none; font-weight: normal; }

        .total-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .total-label { font-size: 14px; color: #888; }
        .total-amount { font-size: 28px; font-weight: 800; color: #333; line-height: 1; }
        
        .action-row { display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 8px; }
        .btn-reset { background: #f1f1f1; color: #666; border: none; padding: 12px; border-radius: 10px; font-weight: bold; }
        .btn-view { background: #e3e3e3; color: #333; border: none; padding: 12px; border-radius: 10px; font-weight: bold; }
        .btn-copy { background: #4a4a4a; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-copy:active { background: #222; }

        /* --- æ˜ç´°å½ˆçª—æ¨£å¼ (UI é¡¯ç¤ºç”¨) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 999;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.3s;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        
        .modal-card {
            background: white; width: 90%; max-width: 350px;
            border-radius: 15px; padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: translateY(20px); transition: all 0.3s;
            display: flex; flex-direction: column; max-height: 80vh;
        }
        .modal-overlay.show .modal-card { transform: translateY(0); }

        .receipt-header { text-align: center; border-bottom: 2px dashed #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .receipt-header h3 { margin: 0; color: #333; font-size: 18px; }
        .receipt-header p { margin: 5px 0 0; color: #999; font-size: 12px; }

        .receipt-body { flex: 1; overflow-y: auto; font-family: monospace; font-size: 14px; margin-bottom: 15px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .receipt-row.sub { color: #888; font-size: 12px; margin-top: -6px; margin-bottom: 8px; justify-content: flex-end; }
        
        .receipt-footer { border-top: 2px dashed #eee; padding-top: 15px; }
        .receipt-total { display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; color: #333; }
        
        /* å½ˆçª—æŒ‰éˆ•å€ - ä¿®æ”¹ç‚ºé›™æŒ‰éˆ• */
        .modal-actions {
            display: flex; gap: 10px; margin-top: 15px;
        }
        .btn-close { 
            flex: 1; background: #f1f1f1; border: none; padding: 12px; 
            border-radius: 10px; font-weight: bold; color: #666;
        }
        .btn-download {
            flex: 1.5; background: var(--milk-tea-text); border: none; padding: 12px;
            border-radius: 10px; font-weight: bold; color: white;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        /* --- éš±è—çš„ Export å®¹å™¨ (å°ˆé–€çµ¦ html2canvas æ‹ç…§ç”¨) --- */
        /* æ–¹æ¡ˆ Aï¼šå›ºå®šé«˜åº¦ + å‚ç›´ç½®ä¸­ */
    #exportContainer {
    position: fixed;
    left: -9999px; top: 0;
    width: 420px;            /* å›ºå®šå¯¬åº¦ */
    min-height: 600px;       /* å›ºå®šæœ€å°é«˜åº¦ (ä¿æŒé•·æ–¹å½¢æ¯”ä¾‹) */
    background-color: var(--milk-tea-bg);
    padding: 40px;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    
    display: flex;
    align-items: center;     /* â˜…é—œéµä¿®æ”¹ï¼šæ”¹æˆ center (å‚ç›´ç½®ä¸­) */
    justify-content: center; /* æ°´å¹³ç½®ä¸­ */
}
        /* 1A: æ‹ç«‹å¾—é¢¨æ ¼ç™½å¡ç‰‡ */
        .export-card {
            width: 100%;
            background: #fff;
            padding: 30px;
            border-radius: 4px; /* æ‹ç«‹å¾—é€šå¸¸åœ“è§’è¼ƒå°ï¼Œæˆ–ç”¨ 12px */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            color: var(--milk-tea-text);
        }
        /* 3A: è¥¯ç·šå­—é«” Header */
        .export-header { text-align: center; margin-bottom: 25px; }
        .export-header h3 { 
            font-family: "Georgia", "Times New Roman", serif; 
            font-size: 28px; margin: 0; letter-spacing: 1px; color: var(--milk-tea-text);
        }
        .export-header p { font-size: 12px; color: #999; margin-top: 8px; font-family: monospace; }
        
        .export-body { margin-bottom: 20px; min-height: 100px; }
        .export-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 15px; }
        .export-row-sub { text-align: right; font-size: 12px; color: #888; margin-top: -8px; margin-bottom: 12px; }

        /* 2C: è™›ç·šè£é£¾ */
        .export-divider { border-top: 2px dashed #ddd; margin: 20px 0; }
        
        .export-total { display: flex; justify-content: space-between; align-items: center; }
        .export-total span:first-child { font-size: 14px; color: #888; }
        .export-total span:last-child { font-size: 28px; font-weight: bold; color: var(--milk-tea-text); }
        
        /* åº•éƒ¨åº—èˆ–è³‡è¨Š */
        .export-footer-info {
            margin-top: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0;
            text-align: center; font-size: 12px; color: #888; line-height: 1.6;
        }


        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 200px; background-color: rgba(0,0,0,0.8); color: #fff;
            text-align: center; border-radius: 25px; padding: 12px; position: fixed; z-index: 9999;
            left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        @keyframes fadein { from {bottom: 60px; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 60px; opacity: 0;} }
    </style>
</head>
<body>

<header>
    <div class="mode-switch">
        <button class="mode-btn active" onclick="setMode('hand')">ğŸ–ï¸ æ‰‹éƒ¨</button>
        <button class="mode-btn" onclick="setMode('foot')">ğŸ¦¶ è¶³éƒ¨ (+$100)</button>
    </div>
    <div class="category-scroll" id="categoryList"></div>
</header>

<main>
    <div class="item-container" id="itemList"></div>

    <div class="cart-section">
        <div class="cart-title">
            <span>å·²é¸é …ç›® (é»æ“Šå¯ç·¨è¼¯)</span>
            <span style="font-size:12px">æ‰“æŠ˜?</span>
        </div>
        <div id="cartList"></div>
    </div>
</main>

<div class="checkout-bar">
    <div class="discount-options">
        <div class="disc-btn selected" onclick="setDiscount(1, this)">åŸåƒ¹</div>
        <div class="disc-btn" onclick="setDiscount(0.9, this)">9æŠ˜</div>
        <div class="disc-btn" onclick="setDiscount(0.7, this)">7æŠ˜</div>
        
        <div class="disc-input-wrapper">
            <input type="number" id="customRateInput" placeholder="è‡ªè¨‚" oninput="applyCustomDiscount(this.value)">
            <span class="disc-unit">æŠ˜/%</span>
        </div>
    </div>

    <div class="total-row">
        <div class="total-label">ç¸½é‡‘é¡ Total</div>
        <div class="total-amount" id="finalTotal">$0</div>
    </div>

    <div class="action-row">
        <button class="btn-reset" onclick="resetCart()">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button class="btn-view" onclick="showDetailModal()">ğŸ“„ æŸ¥çœ‹</button>
        <button class="btn-copy" onclick="copyReceipt()">ğŸ“‹ è¤‡è£½</button>
    </div>
</div>

<div id="toast">å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>

<div id="detailModal" class="modal-overlay" onclick="if(event.target === this) closeDetailModal()">
    <div class="modal-card">
        <div class="receipt-header">
            <h3>Jamie's Nail</h3>
            <p id="receiptDate">2026/01/17</p>
        </div>
        <div class="receipt-body" id="receiptContent"></div>
        <div class="receipt-footer">
            <div class="receipt-total">
                <span>ç¸½é‡‘é¡</span>
                <span id="receiptTotal">$0</span>
            </div>
            <div class="modal-actions">
                <button class="btn-close" onclick="closeDetailModal()">é—œé–‰</button>
                <button class="btn-download" onclick="downloadReceiptImage()">
                    ğŸ“¥ å­˜æˆåœ–ç‰‡
                </button>
            </div>
        </div>
    </div>
</div>

<div id="exportContainer">
    <div class="export-card">
        <div class="export-header">
            <h3>Jamie's Nail</h3>
            <p id="exportDate">DATE</p>
        </div>
        
        <div class="export-body" id="exportContent">
            </div>

        <div class="export-divider"></div>

        <div class="export-total">
            <span>TOTAL AMOUNT</span>
            <span id="exportTotalVal">$0</span>
        </div>

        <div class="export-footer-info">
            IG: @0_jamie.s_nail_0<br>
            Line: @sfd4831c
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. è¨­å®šæª” (Configuration)
    // ==========================================
    const CONFIG = {
        footSurcharge: 100,
        categories: [
            { id: 'care', name: 'åŸºç¤ä¿é¤Š' },
            { id: 'gel', name: 'å‡è† é …ç›®' },
            { id: 'art', name: 'é€ å‹è¨­è¨ˆ' },
            { id: 'remove', name: 'å¸ç”²/ç¶­è­·' },
            { id: 'adjust', name: 'èª¿æ•´/æŠ˜æ‰£' }
        ],
        menu: {
            care: [
                { name: 'åŸºç¤ä¿é¤Š', price: 500 },
                { name: 'å«©è†šä¿é¤Š', price: 700 },
                { name: 'æ·±å±¤ä¿é¤Š', price: 1000 }
            ],
            gel: [
                { name: 'é€æ˜å‡è† ', price: 780 },
                { name: 'å–®è‰²å‡è† ', price: 1000 },
                { name: 'é¡é¢ç²‰', price: 1200 },
                { name: 'è²“çœ¼', price: 1100 },
                { name: 'æ³•å¼', price: 1300 },
                { name: 'æ¼¸å±¤', price: 1200 },
                { name: 'å„ªæƒ æ¬¾', price: 1399 }, 
                { name: 'åº•è‰²', price: 300 }
            ],
            art: [
                { name: 'é€ å‹(A)', price: 100 },
                { name: 'é€ å‹(B)', price: 150 },
                { name: 'é€ å‹(C)', price: 200 },
                { name: 'è²¼ç´™/é£¾å“', price: 50 },
                { name: 'è£œæ–·ç”²(å–®æŒ‡)', price: 100 }
            ],
            remove: [
                { name: 'æœ¬åº—å¸ç”²çºŒä½œ', price: 200 },
                { name: 'ä»–åº—å¸ç”²çºŒä½œ', price: 300 },
                { name: 'å¸å‡è† ï¼ˆå››æŒ‡ä»¥ä¸‹ï¼‰', price: 50 },
                { name: 'æœ¬åº—ç´”å¸ç”²ï¼ˆå«ä¿®å‰ªï¼‰', price: 500 },
                { name: 'ä»–åº—ç´”å¸ç”²ï¼ˆå«ä¿®å‰ªï¼‰', price: 600 }
            ],
            adjust: [
                { name: 'é¦–å®¢æŠ˜æŠµ', price: -100, isFlat: true },
                { name: 'è¨‚é‡‘æ‰£é™¤', price: -1000, isFlat: true }
            ]
        }
    };

    // ==========================================
    // 2. ç‹€æ…‹ç®¡ç† (State)
    // ==========================================
    let state = {
        mode: 'hand', // 'hand' or 'foot'
        currentCat: 'gel',
        cart: [], 
        globalDiscount: 1 
    };

    const savedState = localStorage.getItem('jamieNailStateV5');
    if (savedState) {
        const parsed = JSON.parse(savedState);
        state.cart = parsed.cart || [];
    }

    // ==========================================
    // 3. æ ¸å¿ƒåŠŸèƒ½ (Functions)
    // ==========================================

    function init() {
        renderCategories();
        renderItems();
        renderCart();
        updateTotal();
    }

    function setMode(mode) {
        state.mode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        if (mode === 'foot') {
            document.querySelector('button[onclick="setMode(\'foot\')"]').classList.add('active');
            document.body.classList.add('foot-mode');
        } else {
            document.querySelector('button[onclick="setMode(\'hand\')"]').classList.add('active');
            document.body.classList.remove('foot-mode');
        }
        renderItems();
    }

    function setCategory(catId) {
        state.currentCat = catId;
        renderCategories();
        renderItems();
    }

    function renderCategories() {
        const container = document.getElementById('categoryList');
        if(!container) return;
        container.innerHTML = CONFIG.categories.map(cat => `
            <button class="cat-btn ${state.currentCat === cat.id ? 'active' : ''}" 
                    onclick="setCategory('${cat.id}')">
                ${cat.name}
            </button>
        `).join('');
    }

    function renderItems() {
        const container = document.getElementById('itemList');
        if(!container) return;
        const items = CONFIG.menu[state.currentCat];
        let html = '';
        
        if (state.currentCat === 'art' || state.currentCat === 'adjust') {
            html += `
                <div class="custom-input-group">
                    <input type="text" id="customName" placeholder="é …ç›®åç¨±">
                    <input type="number" id="customPrice" placeholder="é‡‘é¡">
                    <button class="custom-btn" onclick="addCustomItem()">åŠ å…¥</button>
                </div>
            `;
        }

        html += items.map(item => {
            let displayPrice = item.price;
            let displayName = item.name;
            let isPlus = false;

            if (state.mode === 'foot' && !item.isFlat && state.currentCat !== 'adjust') {
                displayPrice += CONFIG.footSurcharge;
                displayName = `è¶³éƒ¨${item.name}`;
                isPlus = true;
            } else if (state.mode === 'hand' && !item.isFlat && state.currentCat !== 'adjust') {
                displayName = `æ‰‹éƒ¨${item.name}`;
            }

            return `
                <div class="item-card" onclick="addToCart('${displayName}', ${displayPrice})">
                    <div class="item-name">${item.name}</div>
                    <div class="item-price" style="${isPlus ? 'color:#d63031;font-weight:bold' : ''}">
                        $${displayPrice}
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = html;
    }

    function addToCart(name, price) {
        const newItem = {
            id: Date.now(),
            name: name,
            price: parseInt(price),
            discountActive: false
        };
        state.cart.push(newItem);
        saveState();
        renderCart();
        updateTotal();
    }

    function addCustomItem() {
        const nameInput = document.getElementById('customName');
        const priceInput = document.getElementById('customPrice');
        const name = nameInput.value.trim();
        const price = parseInt(priceInput.value);
        if (name && !isNaN(price)) {
            let finalName = name;
            if (state.mode === 'foot' && price > 0) finalName = `(è¶³) ${name}`;
            addToCart(finalName, price);
            nameInput.value = '';
            priceInput.value = '';
        }
    }

    function renderCart() {
        const container = document.getElementById('cartList');
        if (state.cart.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#ccc;padding:20px;">å°šç„¡é …ç›®</div>';
            return;
        }

        container.innerHTML = state.cart.map((item, index) => {
            const isNegative = item.price < 0;
            const itemClass = isNegative ? 'cart-item adjustment' : 
                              (item.discountActive ? 'cart-item discount-active' : 'cart-item');
            
            return `
                <div class="${itemClass}">
                    <div class="check-col">
                        <input type="checkbox" class="discount-checkbox" 
                               onchange="toggleDiscount(${index})" 
                               ${item.discountActive ? 'checked' : ''}
                               ${isNegative ? 'disabled' : ''}> ${!isNegative ? '<span class="discount-label">æŠ˜æ‰£</span>' : ''}
                    </div>
                    <div class="info-col">
                        <input type="text" class="edit-input" value="${item.name}" 
                               onchange="updateItemName(${index}, this.value)">
                        <input type="number" class="edit-price" value="${item.price}" 
                               onchange="updateItemPrice(${index}, this.value)">
                    </div>
                    <div class="action-col">
                        <button class="del-btn" onclick="removeItem(${index})">âœ•</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function removeItem(index) {
        state.cart.splice(index, 1);
        saveState();
        renderCart();
        updateTotal();
    }

    function updateItemName(index, val) {
        state.cart[index].name = val;
        saveState();
    }

    function updateItemPrice(index, val) {
        state.cart[index].price = parseInt(val);
        saveState();
        updateTotal();
    }

    function toggleDiscount(index) {
        state.cart[index].discountActive = !state.cart[index].discountActive;
        saveState();
        renderCart();
        updateTotal();
    }

    function setDiscount(rate, btnElement) {
        state.globalDiscount = rate;
        document.querySelectorAll('.disc-btn').forEach(btn => btn.classList.remove('selected'));
        if(btnElement) btnElement.classList.add('selected');
        
        const input = document.getElementById('customRateInput');
        if(input) input.value = ''; 
        updateTotal();
    }

    function applyCustomDiscount(val) {
        document.querySelectorAll('.disc-btn').forEach(btn => btn.classList.remove('selected'));
        if (!val) {
            state.globalDiscount = 1;
        } else {
            let num = parseFloat(val);
            if (num > 10) state.globalDiscount = num / 100;
            else if (num >= 1 && num <= 10) state.globalDiscount = num / 10;
            else if (num < 1 && num > 0) state.globalDiscount = num;
        }
        updateTotal();
    }

    function updateTotal() {
        let total = 0;
        state.cart.forEach(item => {
            if (item.discountActive) {
                total += Math.round(item.price * state.globalDiscount);
            } else {
                total += item.price;
            }
        });
        document.getElementById('finalTotal').innerText = '$' + total;
    }

    function resetCart() {
        if(confirm('ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ')) {
            state.cart = [];
            saveState();
            renderCart();
            updateTotal();
        }
    }

    function saveState() {
        localStorage.setItem('jamieNailStateV5', JSON.stringify({ cart: state.cart }));
    }

    // ==========================================
    // 4. è¼¸å‡ºåŠŸèƒ½ (Generate Receipt)
    // ==========================================
    function getDiscountText(rate) {
        if (rate === 1) return 'åŸåƒ¹';
        let percent = Math.round(rate * 100);
        if (percent % 10 === 0) return (percent / 10) + 'æŠ˜';
        else return percent + 'æŠ˜';
    }

    function copyReceipt() {
        if (state.cart.length === 0) return;
        const now = new Date();
        const dateStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

        let text = `ã€Jamie's Nail æœå‹™æ˜ç´°ã€‘\n`;
        text += `ğŸ“… ${dateStr}\n\n`;
        state.cart.forEach(item => {
            let line = `â–ªï¸ ${item.name} $${item.price}`;
            if (item.discountActive && state.globalDiscount < 1) {
                const discountedPrice = Math.round(item.price * state.globalDiscount);
                const discountText = getDiscountText(state.globalDiscount);
                line += ` (${discountText}å¾Œ $${discountedPrice})`;
            }
            text += `${line}\n`;
        });
        text += `\n-------------------\n`;
        text += `ç¸½é‡‘é¡ï¼š${document.getElementById('finalTotal').innerText}\n`;
        text += `IG: @0_jamie.s_nail_0\nLine: @sfd4831c`;

        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById("toast");
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }).catch(err => {
            alert('è¤‡è£½å¤±æ•—');
        });
    }

    // ==========================================
    // 5. æ˜ç´°å½ˆçª—èˆ‡åœ–ç‰‡ç”Ÿæˆ (Receipt Modal & Image)
    // ==========================================
    function showDetailModal() {
        if (state.cart.length === 0) {
            alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼");
            return;
        }

        const now = new Date();
        const dateStr = `${now.getFullYear()}.${(now.getMonth()+1).toString().padStart(2,'0')}.${now.getDate().toString().padStart(2,'0')}`;
        
        // æ›´æ–° UI å½ˆçª—
        document.getElementById('receiptDate').innerText = dateStr;
        const container = document.getElementById('receiptContent');
        
        // æ›´æ–° Export å®¹å™¨ (éš±è—ç‰ˆ)
        document.getElementById('exportDate').innerText = dateStr;
        const exportContainer = document.getElementById('exportContent');

        let html = '';
        let exportHtml = '';

        state.cart.forEach(item => {
            const isDiscounted = item.discountActive && state.globalDiscount < 1;
            const finalPrice = isDiscounted ? Math.round(item.price * state.globalDiscount) : item.price;
            
            // UI HTML
            html += `
                <div class="receipt-row">
                    <span>${item.name}</span>
                    <span>$${finalPrice}</span>
                </div>
            `;
            if (isDiscounted) {
                html += `<div class="receipt-row sub">(åŸåƒ¹$${item.price} â†˜ ${getDiscountText(state.globalDiscount)})</div>`;
            }

            // Export HTML (çµæ§‹é¡ä¼¼ä½†åˆ†é–‹è™•ç†)
            exportHtml += `
                <div class="export-row">
                    <span>${item.name}</span>
                    <span>$${finalPrice}</span>
                </div>
            `;
            if (isDiscounted) {
                exportHtml += `<div class="export-row-sub">Original $${item.price} (${getDiscountText(state.globalDiscount)})</div>`;
            }
        });

        container.innerHTML = html;
        exportContainer.innerHTML = exportHtml;

        const totalTxt = document.getElementById('finalTotal').innerText;
        document.getElementById('receiptTotal').innerText = totalTxt;
        document.getElementById('exportTotalVal').innerText = totalTxt;

        document.getElementById('detailModal').classList.add('show');
    }

    function closeDetailModal() {
        document.getElementById('detailModal').classList.remove('show');
    }

    // ç”Ÿæˆä¸¦ä¸‹è¼‰/åˆ†äº«åœ–ç‰‡
    function downloadReceiptImage() {
        const element = document.getElementById('exportContainer');
        const btn = document.querySelector('.btn-download');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'â³ è™•ç†ä¸­...';
        btn.disabled = true;

        html2canvas(element, {
            scale: 3, // é«˜ç•«è³ª (Retina)
            backgroundColor: null, // ä½¿ç”¨ CSS å®šç¾©çš„å¥¶èŒ¶è‰²
            useCORS: true
        }).then(canvas => {
            canvas.toBlob(blob => {
                const fileName = `JamiesNail_${Date.now()}.png`;
                const file = new File([blob], fileName, { type: 'image/png' });

                // å˜—è©¦ä½¿ç”¨åŸç”Ÿåˆ†äº« (æ‰‹æ©Ÿé©ç”¨)
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    navigator.share({
                        files: [file],
                        title: 'Jamie\'s Nail Receipt',
                        text: 'Thank you for coming!'
                    }).catch(err => {
                        console.log('Share failed', err);
                        forceDownload(blob, fileName); // åˆ†äº«å¤±æ•—å‰‡ä¸‹è¼‰
                    });
                } else {
                    // é›»è…¦æˆ–ä¸æ”¯æ´åˆ†äº«çš„ç’°å¢ƒ -> ç›´æ¥ä¸‹è¼‰
                    forceDownload(blob, fileName);
                }

                // å¾©åŸæŒ‰éˆ•
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 'image/png');
        });
    }

    function forceDownload(blob, filename) {
        const link = document.createElement('a');
        link.download = filename;
        link.href = URL.createObjectURL(blob);
        link.click();
        URL.revokeObjectURL(link.href);
    }

    init();
</script>
</body>
</html>




